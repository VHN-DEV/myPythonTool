#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Tool: QuÃ©t vÃ  phÃ¡t hiá»‡n mÃ£ Ä‘á»™c trong file code

Má»¥c Ä‘Ã­ch: PhÃ¡t hiá»‡n cÃ¡c pattern mÃ£ Ä‘á»™c, backdoor trong file PHP, JS, Python
LÃ½ do: Báº£o vá»‡ dá»± Ã¡n khá»i mÃ£ Ä‘á»™c, shell, backdoor
"""

import os
import sys
import re
import csv
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Tuple

# ThÃªm thÆ° má»¥c cha vÃ o sys.path Ä‘á»ƒ import utils
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from utils import (
    print_header, get_user_input, confirm_action,
    ensure_directory_exists, log_info, log_error, normalize_path
)
from utils.colors import Colors


# CÃ¡c pattern nghi ngá» mÃ£ Ä‘á»™c
SUSPICIOUS_PATTERNS = {
    'php': [
        (r'eval\s*\(', 'eval() - Code execution'),
        (r'base64_decode\s*\(', 'base64_decode() - Decode malicious code'),
        (r'gzinflate\s*\(', 'gzinflate() - Decompress malicious code'),
        (r'file_get_contents\s*\(["\']?http', 'file_get_contents() with remote URL - Remote file inclusion'),
        (r'shell_exec\s*\(', 'shell_exec() - Execute system commands'),
        (r'system\s*\(', 'system() - Execute system commands'),
        (r'passthru\s*\(', 'passthru() - Execute system commands'),
        (r'exec\s*\(', 'exec() - Execute system commands'),
        (r'preg_replace\s*\([^)]*/e', 'preg_replace() with /e modifier - Code injection'),
        (r'preg_replace_callback.*\$_(?:GET|POST|REQUEST)', 'preg_replace_callback with user input'),
        (r'eval\s*\(\s*\$_(?:GET|POST|REQUEST|COOKIE)', 'eval() with user input'),
        (r'assert\s*\(', 'assert() - Code execution'),
        (r'create_function\s*\(', 'create_function() - Code injection'),
        (r'call_user_func\s*\(\s*["\']?eval', 'call_user_func() with eval'),
        (r'call_user_func_array\s*\(\s*["\']?eval', 'call_user_func_array() with eval'),
        (r'include\s*\(\s*\$_(?:GET|POST|REQUEST)', 'include() with user input'),
        (r'require\s*\(\s*\$_(?:GET|POST|REQUEST)', 'require() with user input'),
    ],
    'javascript': [
        (r'eval\s*\(', 'eval() - Code execution'),
        (r'Function\s*\(', 'Function() constructor - Code execution'),
        (r'setTimeout\s*\(\s*["\']', 'setTimeout() with string - Code execution'),
        (r'setInterval\s*\(\s*["\']', 'setInterval() with string - Code execution'),
        (r'document\.write\s*\(\s*document\.cookie', 'document.write() with cookie - XSS'),
        (r'innerHTML\s*=.*\$_(?:GET|POST)', 'innerHTML with user input - XSS'),
        (r'location\s*=\s*.*\$_(?:GET|POST)', 'location redirect with user input'),
        (r'document\.location\s*=.*\$_(?:GET|POST)', 'document.location with user input'),
    ],
    'python': [
        (r'eval\s*\(', 'eval() - Code execution'),
        (r'exec\s*\(', 'exec() - Code execution'),
        (r'__import__\s*\(', '__import__() - Dynamic import'),
        (r'compile\s*\(.*mode\s*=\s*["\']exec', 'compile() with exec mode'),
        (r'subprocess\.(?:call|Popen)\s*\([^)]*shell\s*=\s*True', 'subprocess with shell=True - Command injection'),
        (r'os\.system\s*\(', 'os.system() - Execute system commands'),
        (r'os\.popen\s*\(', 'os.popen() - Execute system commands'),
        (r'shutil\.\w+\([^)]*\$_(?:GET|POST)', 'shutil with user input'),
    ]
}


def get_patterns_for_ext(ext: str) -> List[Tuple[str, str]]:
    """
    Láº¥y danh sÃ¡ch pattern theo extension
    
    Args:
        ext: Extension file (.php, .js, .py)
    
    Returns:
        list: Danh sÃ¡ch pattern (regex, description)
    """
    ext_lower = ext.lower().lstrip('.')
    if ext_lower == 'php':
        return SUSPICIOUS_PATTERNS['php']
    elif ext_lower == 'js':
        return SUSPICIOUS_PATTERNS['javascript']
    elif ext_lower == 'py':
        return SUSPICIOUS_PATTERNS['python']
    else:
        # Tráº£ vá» táº¥t cáº£ pattern náº¿u khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c
        all_patterns = []
        for patterns in SUSPICIOUS_PATTERNS.values():
            all_patterns.extend(patterns)
        return list(set(all_patterns))  # Remove duplicates


def scan_file(file_path: Path, extensions: List[str]) -> List[Dict]:
    """
    QuÃ©t má»™t file vÃ  tÃ¬m cÃ¡c pattern nghi ngá»
    
    Args:
        file_path: ÄÆ°á»ng dáº«n file
        extensions: Danh sÃ¡ch extension cáº§n quÃ©t
    
    Returns:
        list: Danh sÃ¡ch káº¿t quáº£ phÃ¡t hiá»‡n
    """
    results = []
    file_ext = file_path.suffix.lower()
    
    # Kiá»ƒm tra extension
    if file_ext not in extensions:
        return results
    
    # Láº¥y patterns cho extension nÃ y
    patterns = get_patterns_for_ext(file_ext)
    
    try:
        # Äá»c file vá»›i encoding UTF-8, fallback sang latin-1 náº¿u lá»—i
        encodings = ['utf-8', 'latin-1', 'cp1252']
        content = None
        
        for enc in encodings:
            try:
                with open(file_path, 'r', encoding=enc, errors='ignore') as f:
                    content = f.read()
                break
            except Exception:
                continue
        
        if content is None:
            return results
        
        # QuÃ©t tá»«ng dÃ²ng
        lines = content.split('\n')
        for line_num, line in enumerate(lines, start=1):
            for pattern, description in patterns:
                try:
                    if re.search(pattern, line, re.IGNORECASE):
                        # Escape quotes trong line Ä‘á»ƒ ghi CSV
                        line_escaped = line.replace('"', '""').strip()
                        if len(line_escaped) > 200:
                            line_escaped = line_escaped[:200] + '...'
                        
                        results.append({
                            'file': str(file_path),
                            'line': line_num,
                            'pattern': description,
                            'content': line_escaped
                        })
                        break  # Chá»‰ ghi má»™t láº§n cho má»—i dÃ²ng
                except re.error:
                    continue  # Bá» qua pattern regex lá»—i
                    
    except Exception as e:
        log_error(f"Lá»—i khi Ä‘á»c file {file_path}: {e}")
    
    return results


def scan_directory(directory: Path, extensions: List[str], progress_callback=None) -> List[Dict]:
    """
    QuÃ©t toÃ n bá»™ thÆ° má»¥c
    
    Args:
        directory: ÄÆ°á»ng dáº«n thÆ° má»¥c
        extensions: Danh sÃ¡ch extension cáº§n quÃ©t
        progress_callback: Callback Ä‘á»ƒ cáº­p nháº­t progress
    
    Returns:
        list: Danh sÃ¡ch táº¥t cáº£ káº¿t quáº£ phÃ¡t hiá»‡n
    """
    all_results = []
    total_files = 0
    scanned_files = 0
    
    # Äáº¿m tá»•ng sá»‘ file
    for ext in extensions:
        total_files += len(list(directory.rglob(f'*{ext}')))
    
    # QuÃ©t tá»«ng file
    for ext in extensions:
        for file_path in directory.rglob(f'*{ext}'):
            if progress_callback:
                scanned_files += 1
                progress_callback(scanned_files, total_files, str(file_path))
            
            results = scan_file(file_path, extensions)
            all_results.extend(results)
    
    return all_results


def save_results_csv(results: List[Dict], output_path: Path):
    """
    LÆ°u káº¿t quáº£ ra file CSV
    
    Args:
        results: Danh sÃ¡ch káº¿t quáº£
        output_path: ÄÆ°á»ng dáº«n file CSV
    """
    try:
        with open(output_path, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow(['File', 'Line Number', 'Matched Pattern', 'Content'])
            
            for result in results:
                writer.writerow([
                    result['file'],
                    result['line'],
                    result['pattern'],
                    result['content']
                ])
        
        log_info(f"âœ… ÄÃ£ lÆ°u káº¿t quáº£ CSV: {output_path}")
    except Exception as e:
        log_error(f"âŒ Lá»—i khi lÆ°u CSV: {e}")


def print_summary(results: List[Dict]):
    """
    In tÃ³m táº¯t káº¿t quáº£
    
    Args:
        results: Danh sÃ¡ch káº¿t quáº£
    """
    if not results:
        print(Colors.success("\nâœ… KhÃ´ng phÃ¡t hiá»‡n mÃ£ Ä‘á»™c nÃ o!"))
        return
    
    # NhÃ³m theo file
    files_dict = {}
    for result in results:
        file_path = result['file']
        if file_path not in files_dict:
            files_dict[file_path] = []
        files_dict[file_path].append(result)
    
    print(Colors.warning(f"\nâš ï¸  PhÃ¡t hiá»‡n {len(results)} pattern nghi ngá» trong {len(files_dict)} file(s):"))
    print(Colors.muted("=" * 70))
    
    for file_path, file_results in files_dict.items():
        print(Colors.error(f"\nğŸ“„ {file_path} ({len(file_results)} pattern)"))
        for result in file_results[:5]:  # Chá»‰ hiá»ƒn thá»‹ 5 dÃ²ng Ä‘áº§u
            print(Colors.muted(f"   DÃ²ng {result['line']:4d}: {result['pattern']}"))
            print(Colors.muted(f"            {result['content'][:60]}..."))
        
        if len(file_results) > 5:
            print(Colors.muted(f"   ... vÃ  {len(file_results) - 5} pattern khÃ¡c"))
    
    print(Colors.muted("\n" + "=" * 70))


def main():
    """HÃ m main"""
    print_header()
    print(Colors.primary("  ğŸ” TOOL QUÃ‰T VÃ€ PHÃT HIá»†N MÃƒ Äá»˜C"))
    print("=" * 70)
    print()
    
    # BÆ°á»›c 1: Nháº­p Ä‘Æ°á»ng dáº«n thÆ° má»¥c
    directory = get_user_input("Nháº­p Ä‘Æ°á»ng dáº«n thÆ° má»¥c cáº§n quÃ©t: ", required=True)
    directory = normalize_path(directory)
    directory_path = Path(directory)
    
    if not directory_path.exists():
        print(Colors.error(f"âŒ ThÆ° má»¥c khÃ´ng tá»“n táº¡i: {directory}"))
        return 1
    
    if not directory_path.is_dir():
        print(Colors.error(f"âŒ ÄÆ°á»ng dáº«n khÃ´ng pháº£i thÆ° má»¥c: {directory}"))
        return 1
    
    # BÆ°á»›c 2: Chá»n loáº¡i file
    print("\nğŸ“‹ Chá»n loáº¡i file cáº§n quÃ©t:")
    print("  1. PHP files (*.php)")
    print("  2. JavaScript files (*.js)")
    print("  3. Python files (*.py)")
    print("  4. Táº¥t cáº£ (PHP + JS + Python)")
    print("  5. Custom (nháº­p extension)")
    
    choice = get_user_input("Lá»±a chá»n (1-5): ", required=True)
    
    if choice == '1':
        extensions = ['.php']
    elif choice == '2':
        extensions = ['.js']
    elif choice == '3':
        extensions = ['.py']
    elif choice == '4':
        extensions = ['.php', '.js', '.py']
    elif choice == '5':
        custom_ext = get_user_input("Nháº­p extension (vd: .php, .js): ", required=True)
        extensions = [custom_ext if custom_ext.startswith('.') else f'.{custom_ext}']
    else:
        print(Colors.error("âŒ Lá»±a chá»n khÃ´ng há»£p lá»‡!"))
        return 1
    
    # BÆ°á»›c 3: XÃ¡c nháº­n
    print(f"\nğŸ“ ThÆ° má»¥c: {directory}")
    print(f"ğŸ“„ Loáº¡i file: {', '.join(extensions)}")
    if not confirm_action("Báº¯t Ä‘áº§u quÃ©t?"):
        print("âŒ ÄÃ£ há»§y!")
        return 0
    
    # BÆ°á»›c 4: QuÃ©t
    print(f"\nğŸ” Äang quÃ©t...")
    print(Colors.muted("=" * 70))
    
    def progress_callback(current, total, file_path):
        if current % 10 == 0 or current == total:
            percent = (current / total * 100) if total > 0 else 0
            print(f"\r{Colors.muted(f'ÄÃ£ quÃ©t: {current}/{total} file ({percent:.1f}%)')} - {Path(file_path).name[:40]:<40}", end='', flush=True)
    
    results = scan_directory(directory_path, extensions, progress_callback)
    print()  # New line after progress
    
    # BÆ°á»›c 5: Hiá»ƒn thá»‹ káº¿t quáº£
    print_summary(results)
    
    # BÆ°á»›c 6: LÆ°u CSV
    if results:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        csv_path = directory_path / f"malware_scan_{timestamp}.csv"
        
        save_csv = confirm_action(f"\nğŸ’¾ LÆ°u káº¿t quáº£ ra CSV?", default=True)
        if save_csv:
            save_results_csv(results, csv_path)
            print(Colors.success(f"ğŸ“„ File CSV: {csv_path}"))
    
    print()
    print(Colors.success("âœ… HoÃ n táº¥t!"))
    return 0


if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print(Colors.warning("\nâš ï¸  ÄÃ£ há»§y bá»Ÿi ngÆ°á»i dÃ¹ng!"))
        sys.exit(130)
    except Exception as e:
        log_error(f"âŒ Lá»—i khÃ´ng mong muá»‘n: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

